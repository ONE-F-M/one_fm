import{Fragment as Q,computed as O,defineComponent as H,h as K,inject as A,provide as V,ref as T,shallowRef as ae,watchEffect as _,onMounted as X,onUnmounted as Y}from"vue";import{match as x}from'../../utils/match.js';import{render as G,Features as j}from'../../utils/render.js';import{useId as B}from'../../hooks/use-id.js';import{Keys as M}from'../../keyboard.js';import{getFocusableElements as U,Focus as C,focusIn as k,isFocusableElement as ue,FocusableMode as ie,FocusResult as q}from'../../utils/focus-management.js';import{dom as l}from'../../utils/dom.js';import{useOpenClosedProvider as se,State as L,useOpenClosed as Z}from'../../internal/open-closed.js';import{useResolveButtonType as pe}from'../../hooks/use-resolve-button-type.js';import{useOutsideClick as fe}from'../../hooks/use-outside-click.js';import{getOwnerDocument as N}from'../../utils/owner.js';import{useEventListener as ve}from'../../hooks/use-event-listener.js';import{Hidden as z,Features as J}from'../../internal/hidden.js';import{useTabDirection as ee,Direction as R}from'../../hooks/use-tab-direction.js';import'../../utils/micro-task.js';var ce=(p=>(p[p.Open=0]="Open",p[p.Closed=1]="Closed",p))(ce||{});let te=Symbol("PopoverContext");function W(c){let m=A(te,null);if(m===null){let p=new Error(`<${c} /> is missing a parent <${Pe.name} /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(p,W),p}return m}let oe=Symbol("PopoverGroupContext");function ne(){return A(oe,null)}let le=Symbol("PopoverPanelContext");function de(){return A(le,null)}let Pe=H({name:"Popover",props:{as:{type:[Object,String],default:"div"}},setup(c,{slots:m,attrs:p,expose:y}){var n;let o=T(null);y({el:o,$el:o});let e=T(1),f=T(null),d=T(null),I=T(null),s=T(null),b=O(()=>N(o)),P=O(()=>{var h,D;if(!l(f)||!l(s))return!1;for(let w of document.querySelectorAll("body > *"))if(Number(w==null?void 0:w.contains(l(f)))^Number(w==null?void 0:w.contains(l(s))))return!0;let t=U(),r=t.indexOf(l(f)),u=(r+t.length-1)%t.length,v=(r+1)%t.length,S=t[u],$=t[v];return!((h=l(s))!=null&&h.contains(S))&&!((D=l(s))!=null&&D.contains($))}),a={popoverState:e,buttonId:T(null),panelId:T(null),panel:s,button:f,isPortalled:P,beforePanelSentinel:d,afterPanelSentinel:I,togglePopover(){e.value=x(e.value,{[0]:1,[1]:0})},closePopover(){e.value!==1&&(e.value=1)},close(t){a.closePopover();let r=(()=>t?t instanceof HTMLElement?t:t.value instanceof HTMLElement?l(t):l(a.button):l(a.button))();r==null||r.focus()}};V(te,a),se(O(()=>x(e.value,{[0]:L.Open,[1]:L.Closed})));let F={buttonId:a.buttonId,panelId:a.panelId,close(){a.closePopover()}},g=ne(),E=g==null?void 0:g.registerPopover;function i(){var t,r,u,v;return(v=g==null?void 0:g.isFocusWithinPopoverGroup())!=null?v:((t=b.value)==null?void 0:t.activeElement)&&(((r=l(f))==null?void 0:r.contains(b.value.activeElement))||((u=l(s))==null?void 0:u.contains(b.value.activeElement)))}return _(()=>E==null?void 0:E(F)),ve((n=b.value)==null?void 0:n.defaultView,"focus",t=>{var r,u;e.value===0&&(i()||f&&s&&t.target!==window&&((r=l(a.beforePanelSentinel))!=null&&r.contains(t.target)||(u=l(a.afterPanelSentinel))!=null&&u.contains(t.target)||a.closePopover()))},!0),fe([f,s],(t,r)=>{var u;a.closePopover(),ue(r,ie.Loose)||(t.preventDefault(),(u=l(f))==null||u.focus())},O(()=>e.value===0)),()=>{let t={open:e.value===0,close:a.close};return G({theirProps:c,ourProps:{ref:o},slot:t,slots:m,attrs:p,name:"Popover"})}}}),Be=H({name:"PopoverButton",props:{as:{type:[Object,String],default:"button"},disabled:{type:[Boolean],default:!1},id:{type:String,default:()=>`headlessui-popover-button-${B()}`}},inheritAttrs:!1,setup(c,{attrs:m,slots:p,expose:y}){let o=W("PopoverButton"),e=O(()=>N(o.button));y({el:o.button,$el:o.button}),X(()=>{o.buttonId.value=c.id}),Y(()=>{o.buttonId.value=null});let f=ne(),d=f==null?void 0:f.closeOthers,I=de(),s=O(()=>I===null?!1:I.value===o.panelId.value),b=T(null),P=`headlessui-focus-sentinel-${B()}`;s.value||_(()=>{o.button.value=b.value});let a=pe(O(()=>({as:c.as,type:m.type})),b);function F(n){var t,r,u,v,S;if(s.value){if(o.popoverState.value===1)return;switch(n.key){case M.Space:case M.Enter:n.preventDefault(),(r=(t=n.target).click)==null||r.call(t),o.closePopover(),(u=l(o.button))==null||u.focus();break}}else switch(n.key){case M.Space:case M.Enter:n.preventDefault(),n.stopPropagation(),o.popoverState.value===1&&(d==null||d(o.buttonId.value)),o.togglePopover();break;case M.Escape:if(o.popoverState.value!==0)return d==null?void 0:d(o.buttonId.value);if(!l(o.button)||(v=e.value)!=null&&v.activeElement&&!((S=l(o.button))!=null&&S.contains(e.value.activeElement)))return;n.preventDefault(),n.stopPropagation(),o.closePopover();break}}function g(n){s.value||n.key===M.Space&&n.preventDefault()}function E(n){var t,r;c.disabled||(s.value?(o.closePopover(),(t=l(o.button))==null||t.focus()):(n.preventDefault(),n.stopPropagation(),o.popoverState.value===1&&(d==null||d(o.buttonId.value)),o.togglePopover(),(r=l(o.button))==null||r.focus()))}function i(n){n.preventDefault(),n.stopPropagation()}return()=>{let n=o.popoverState.value===0,t={open:n},{id:r,...u}=c,v=s.value?{ref:b,type:a.value,onKeydown:F,onClick:E}:{ref:b,id:r,type:a.value,"aria-expanded":c.disabled?void 0:o.popoverState.value===0,"aria-controls":l(o.panel)?o.panelId.value:void 0,disabled:c.disabled?!0:void 0,onKeydown:F,onKeyup:g,onClick:E,onMousedown:i},S=ee();function $(){let h=l(o.panel);if(!h)return;function D(){x(S.value,{[R.Forwards]:()=>k(h,C.First),[R.Backwards]:()=>k(h,C.Last)})===q.Error&&k(U().filter(re=>re.dataset.headlessuiFocusGuard!=="true"),x(S.value,{[R.Forwards]:C.Next,[R.Backwards]:C.Previous}),{relativeTo:l(o.button)})}D()}return K(Q,[G({ourProps:v,theirProps:{...m,...u},slot:t,attrs:m,slots:p,name:"PopoverButton"}),n&&!s.value&&o.isPortalled.value&&K(z,{id:P,features:J.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:$})])}}}),Le=H({name:"PopoverOverlay",props:{as:{type:[Object,String],default:"div"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0}},setup(c,{attrs:m,slots:p}){let y=W("PopoverOverlay"),o=`headlessui-popover-overlay-${B()}`,e=Z(),f=O(()=>e!==null?(e.value&L.Open)===L.Open:y.popoverState.value===0);function d(){y.closePopover()}return()=>{let I={open:y.popoverState.value===0};return G({ourProps:{id:o,"aria-hidden":!0,onClick:d},theirProps:c,slot:I,attrs:m,slots:p,features:j.RenderStrategy|j.Static,visible:f.value,name:"PopoverOverlay"})}}}),He=H({name:"PopoverPanel",props:{as:{type:[Object,String],default:"div"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},focus:{type:Boolean,default:!1},id:{type:String,default:()=>`headlessui-popover-panel-${B()}`}},inheritAttrs:!1,setup(c,{attrs:m,slots:p,expose:y}){let{focus:o}=c,e=W("PopoverPanel"),f=O(()=>N(e.panel)),d=`headlessui-focus-sentinel-before-${B()}`,I=`headlessui-focus-sentinel-after-${B()}`;y({el:e.panel,$el:e.panel}),X(()=>{e.panelId.value=c.id}),Y(()=>{e.panelId.value=null}),V(le,e.panelId),_(()=>{var n,t;if(!o||e.popoverState.value!==0||!e.panel)return;let i=(n=f.value)==null?void 0:n.activeElement;(t=l(e.panel))!=null&&t.contains(i)||k(l(e.panel),C.First)});let s=Z(),b=O(()=>s!==null?(s.value&L.Open)===L.Open:e.popoverState.value===0);function P(i){var n,t;switch(i.key){case M.Escape:if(e.popoverState.value!==0||!l(e.panel)||f.value&&!((n=l(e.panel))!=null&&n.contains(f.value.activeElement)))return;i.preventDefault(),i.stopPropagation(),e.closePopover(),(t=l(e.button))==null||t.focus();break}}function a(i){var t,r,u,v,S;let n=i.relatedTarget;n&&l(e.panel)&&((t=l(e.panel))!=null&&t.contains(n)||(e.closePopover(),((u=(r=l(e.beforePanelSentinel))==null?void 0:r.contains)!=null&&u.call(r,n)||(S=(v=l(e.afterPanelSentinel))==null?void 0:v.contains)!=null&&S.call(v,n))&&n.focus({preventScroll:!0})))}let F=ee();function g(){let i=l(e.panel);if(!i)return;function n(){x(F.value,{[R.Forwards]:()=>{var r;k(i,C.First)===q.Error&&((r=l(e.afterPanelSentinel))==null||r.focus())},[R.Backwards]:()=>{var t;(t=l(e.button))==null||t.focus({preventScroll:!0})}})}n()}function E(){let i=l(e.panel);if(!i)return;function n(){x(F.value,{[R.Forwards]:()=>{let t=l(e.button),r=l(e.panel);if(!t)return;let u=U(),v=u.indexOf(t),S=u.slice(0,v+1),h=[...u.slice(v+1),...S];for(let D of h.slice())if(D.dataset.headlessuiFocusGuard==="true"||r!=null&&r.contains(D)){let w=h.indexOf(D);w!==-1&&h.splice(w,1)}k(h,C.First,{sorted:!1})},[R.Backwards]:()=>{var r;k(i,C.Previous)===q.Error&&((r=l(e.button))==null||r.focus())}})}n()}return()=>{let i={open:e.popoverState.value===0,close:e.close},{id:n,focus:t,...r}=c,u={ref:e.panel,id:n,onKeydown:P,onFocusout:o&&e.popoverState.value===0?a:void 0,tabIndex:-1};return G({ourProps:u,theirProps:{...m,...r},attrs:m,slot:i,slots:{...p,default:(...v)=>{var S;return[K(Q,[b.value&&e.isPortalled.value&&K(z,{id:d,ref:e.beforePanelSentinel,features:J.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:g}),(S=p.default)==null?void 0:S.call(p,...v),b.value&&e.isPortalled.value&&K(z,{id:I,ref:e.afterPanelSentinel,features:J.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:E})])]}},features:j.RenderStrategy|j.Static,visible:b.value,name:"PopoverPanel"})}}}),Ke=H({name:"PopoverGroup",props:{as:{type:[Object,String],default:"div"}},setup(c,{attrs:m,slots:p,expose:y}){let o=T(null),e=ae([]),f=O(()=>N(o));y({el:o,$el:o});function d(P){let a=e.value.indexOf(P);a!==-1&&e.value.splice(a,1)}function I(P){return e.value.push(P),()=>{d(P)}}function s(){var F;let P=f.value;if(!P)return!1;let a=P.activeElement;return(F=l(o))!=null&&F.contains(a)?!0:e.value.some(g=>{var E,i;return((E=P.getElementById(g.buttonId.value))==null?void 0:E.contains(a))||((i=P.getElementById(g.panelId.value))==null?void 0:i.contains(a))})}function b(P){for(let a of e.value)a.buttonId.value!==P&&a.close()}return V(oe,{registerPopover:I,unregisterPopover:d,isFocusWithinPopoverGroup:s,closeOthers:b}),()=>G({ourProps:{ref:o},theirProps:c,slot:{},attrs:m,slots:p,name:"PopoverGroup"})}});export{Pe as Popover,Be as PopoverButton,Ke as PopoverGroup,Le as PopoverOverlay,He as PopoverPanel};
