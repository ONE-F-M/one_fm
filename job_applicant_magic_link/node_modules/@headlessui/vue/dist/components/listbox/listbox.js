import{Fragment as Q,computed as O,defineComponent as I,h as K,inject as z,nextTick as C,onMounted as A,onUnmounted as _,provide as q,ref as D,toRaw as T,watch as N,watchEffect as W}from"vue";import{Features as H,render as E,omit as G,compact as J}from'../../utils/render.js';import{useId as F}from'../../hooks/use-id.js';import{Keys as c}from'../../keyboard.js';import{calculateActiveIndex as X,Focus as g}from'../../utils/calculate-active-index.js';import{dom as v}from'../../utils/dom.js';import{useOpenClosed as Y,State as B,useOpenClosedProvider as Z}from'../../internal/open-closed.js';import{match as P}from'../../utils/match.js';import{useResolveButtonType as ee}from'../../hooks/use-resolve-button-type.js';import{FocusableMode as te,isFocusableElement as oe,sortByDomNode as ie}from'../../utils/focus-management.js';import{useOutsideClick as ae}from'../../hooks/use-outside-click.js';import{Hidden as ne,Features as le}from'../../internal/hidden.js';import{objectToFormEntries as ue}from'../../utils/form.js';import{useControllable as re}from'../../hooks/use-controllable.js';import{useTrackedPointer as se}from'../../hooks/use-tracked-pointer.js';function de(t,b){return t===b}var fe=(u=>(u[u.Open=0]="Open",u[u.Closed=1]="Closed",u))(fe||{}),pe=(u=>(u[u.Single=0]="Single",u[u.Multi=1]="Multi",u))(pe||{}),ce=(u=>(u[u.Pointer=0]="Pointer",u[u.Other=1]="Other",u))(ce||{});function ve(t){requestAnimationFrame(()=>requestAnimationFrame(t))}let U=Symbol("ListboxContext");function j(t){let b=z(U,null);if(b===null){let u=new Error(`<${t} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(u,j),u}return b}let je=I({name:"Listbox",emits:{"update:modelValue":t=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},by:{type:[String,Function],default:()=>de},horizontal:{type:[Boolean],default:!1},modelValue:{type:[Object,String,Number,Boolean],default:void 0},defaultValue:{type:[Object,String,Number,Boolean],default:void 0},form:{type:String,optional:!0},name:{type:String,optional:!0},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(t,{slots:b,attrs:u,emit:L}){let e=D(1),d=D(null),m=D(null),x=D(null),f=D([]),o=D(""),i=D(null),w=D(1);function R(a=l=>l){let l=i.value!==null?f.value[i.value]:null,r=ie(a(f.value.slice()),S=>v(S.dataRef.domRef)),s=l?r.indexOf(l):null;return s===-1&&(s=null),{options:r,activeOptionIndex:s}}let h=O(()=>t.multiple?1:0),[y,M]=re(O(()=>t.modelValue===void 0?P(h.value,{[1]:[],[0]:void 0}):t.modelValue),a=>L("update:modelValue",a),O(()=>t.defaultValue)),n={listboxState:e,value:y,mode:h,compare(a,l){if(typeof t.by=="string"){let r=t.by;return(a==null?void 0:a[r])===(l==null?void 0:l[r])}return t.by(a,l)},orientation:O(()=>t.horizontal?"horizontal":"vertical"),labelRef:d,buttonRef:m,optionsRef:x,disabled:O(()=>t.disabled),options:f,searchQuery:o,activeOptionIndex:i,activationTrigger:w,closeListbox(){t.disabled||e.value!==1&&(e.value=1,i.value=null)},openListbox(){t.disabled||e.value!==0&&(e.value=0)},goToOption(a,l,r){if(t.disabled||e.value===1)return;let s=R(),S=X(a===g.Specific?{focus:g.Specific,id:l}:{focus:a},{resolveItems:()=>s.options,resolveActiveIndex:()=>s.activeOptionIndex,resolveId:k=>k.id,resolveDisabled:k=>k.dataRef.disabled});o.value="",i.value=S,w.value=r!=null?r:1,f.value=s.options},search(a){if(t.disabled||e.value===1)return;let r=o.value!==""?0:1;o.value+=a.toLowerCase();let S=(i.value!==null?f.value.slice(i.value+r).concat(f.value.slice(0,i.value+r)):f.value).find(V=>V.dataRef.textValue.startsWith(o.value)&&!V.dataRef.disabled),k=S?f.value.indexOf(S):-1;k===-1||k===i.value||(i.value=k,w.value=1)},clearSearch(){t.disabled||e.value!==1&&o.value!==""&&(o.value="")},registerOption(a,l){let r=R(s=>[...s,{id:a,dataRef:l}]);f.value=r.options,i.value=r.activeOptionIndex},unregisterOption(a){let l=R(r=>{let s=r.findIndex(S=>S.id===a);return s!==-1&&r.splice(s,1),r});f.value=l.options,i.value=l.activeOptionIndex,w.value=1},select(a){t.disabled||M(P(h.value,{[0]:()=>a,[1]:()=>{let l=T(n.value.value).slice(),r=T(a),s=l.findIndex(S=>n.compare(r,T(S)));return s===-1?l.push(r):l.splice(s,1),l}}))}};ae([m,x],(a,l)=>{var r;n.closeListbox(),oe(l,te.Loose)||(a.preventDefault(),(r=v(m))==null||r.focus())},O(()=>e.value===0)),q(U,n),Z(O(()=>P(e.value,{[0]:B.Open,[1]:B.Closed})));let p=O(()=>{var a;return(a=v(m))==null?void 0:a.closest("form")});return A(()=>{N([p],()=>{if(!p.value||t.defaultValue===void 0)return;function a(){n.select(t.defaultValue)}return p.value.addEventListener("reset",a),()=>{var l;(l=p.value)==null||l.removeEventListener("reset",a)}},{immediate:!0})}),()=>{let{name:a,modelValue:l,disabled:r,form:s,...S}=t,k={open:e.value===0,disabled:r,value:y.value};return K(Q,[...a!=null&&y.value!=null?ue({[a]:y.value}).map(([V,$])=>K(ne,J({features:le.Hidden,key:V,as:"input",type:"hidden",hidden:!0,readOnly:!0,form:s,name:V,value:$}))):[],E({ourProps:{},theirProps:{...u,...G(S,["defaultValue","onUpdate:modelValue","horizontal","multiple","by"])},slot:k,slots:b,attrs:u,name:"Listbox"})])}}}),Ae=I({name:"ListboxLabel",props:{as:{type:[Object,String],default:"label"},id:{type:String,default:()=>`headlessui-listbox-label-${F()}`}},setup(t,{attrs:b,slots:u}){let L=j("ListboxLabel");function e(){var d;(d=v(L.buttonRef))==null||d.focus({preventScroll:!0})}return()=>{let d={open:L.listboxState.value===0,disabled:L.disabled.value},{id:m,...x}=t,f={id:m,ref:L.labelRef,onClick:e};return E({ourProps:f,theirProps:x,slot:d,attrs:b,slots:u,name:"ListboxLabel"})}}}),Fe=I({name:"ListboxButton",props:{as:{type:[Object,String],default:"button"},id:{type:String,default:()=>`headlessui-listbox-button-${F()}`}},setup(t,{attrs:b,slots:u,expose:L}){let e=j("ListboxButton");L({el:e.buttonRef,$el:e.buttonRef});function d(o){switch(o.key){case c.Space:case c.Enter:case c.ArrowDown:o.preventDefault(),e.openListbox(),C(()=>{var i;(i=v(e.optionsRef))==null||i.focus({preventScroll:!0}),e.value.value||e.goToOption(g.First)});break;case c.ArrowUp:o.preventDefault(),e.openListbox(),C(()=>{var i;(i=v(e.optionsRef))==null||i.focus({preventScroll:!0}),e.value.value||e.goToOption(g.Last)});break}}function m(o){switch(o.key){case c.Space:o.preventDefault();break}}function x(o){e.disabled.value||(e.listboxState.value===0?(e.closeListbox(),C(()=>{var i;return(i=v(e.buttonRef))==null?void 0:i.focus({preventScroll:!0})})):(o.preventDefault(),e.openListbox(),ve(()=>{var i;return(i=v(e.optionsRef))==null?void 0:i.focus({preventScroll:!0})})))}let f=ee(O(()=>({as:t.as,type:b.type})),e.buttonRef);return()=>{var h,y;let o={open:e.listboxState.value===0,disabled:e.disabled.value,value:e.value.value},{id:i,...w}=t,R={ref:e.buttonRef,id:i,type:f.value,"aria-haspopup":"listbox","aria-controls":(h=v(e.optionsRef))==null?void 0:h.id,"aria-expanded":e.disabled.value?void 0:e.listboxState.value===0,"aria-labelledby":e.labelRef.value?[(y=v(e.labelRef))==null?void 0:y.id,i].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:d,onKeyup:m,onClick:x};return E({ourProps:R,theirProps:w,slot:o,attrs:b,slots:u,name:"ListboxButton"})}}}),Be=I({name:"ListboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},id:{type:String,default:()=>`headlessui-listbox-options-${F()}`}},setup(t,{attrs:b,slots:u,expose:L}){let e=j("ListboxOptions"),d=D(null);L({el:e.optionsRef,$el:e.optionsRef});function m(o){switch(d.value&&clearTimeout(d.value),o.key){case c.Space:if(e.searchQuery.value!=="")return o.preventDefault(),o.stopPropagation(),e.search(o.key);case c.Enter:if(o.preventDefault(),o.stopPropagation(),e.activeOptionIndex.value!==null){let i=e.options.value[e.activeOptionIndex.value];e.select(i.dataRef.value)}e.mode.value===0&&(e.closeListbox(),C(()=>{var i;return(i=v(e.buttonRef))==null?void 0:i.focus({preventScroll:!0})}));break;case P(e.orientation.value,{vertical:c.ArrowDown,horizontal:c.ArrowRight}):return o.preventDefault(),o.stopPropagation(),e.goToOption(g.Next);case P(e.orientation.value,{vertical:c.ArrowUp,horizontal:c.ArrowLeft}):return o.preventDefault(),o.stopPropagation(),e.goToOption(g.Previous);case c.Home:case c.PageUp:return o.preventDefault(),o.stopPropagation(),e.goToOption(g.First);case c.End:case c.PageDown:return o.preventDefault(),o.stopPropagation(),e.goToOption(g.Last);case c.Escape:o.preventDefault(),o.stopPropagation(),e.closeListbox(),C(()=>{var i;return(i=v(e.buttonRef))==null?void 0:i.focus({preventScroll:!0})});break;case c.Tab:o.preventDefault(),o.stopPropagation();break;default:o.key.length===1&&(e.search(o.key),d.value=setTimeout(()=>e.clearSearch(),350));break}}let x=Y(),f=O(()=>x!==null?(x.value&B.Open)===B.Open:e.listboxState.value===0);return()=>{var h,y,M,n;let o={open:e.listboxState.value===0},{id:i,...w}=t,R={"aria-activedescendant":e.activeOptionIndex.value===null||(h=e.options.value[e.activeOptionIndex.value])==null?void 0:h.id,"aria-multiselectable":e.mode.value===1?!0:void 0,"aria-labelledby":(n=(y=v(e.labelRef))==null?void 0:y.id)!=null?n:(M=v(e.buttonRef))==null?void 0:M.id,"aria-orientation":e.orientation.value,id:i,onKeydown:m,role:"listbox",tabIndex:0,ref:e.optionsRef};return E({ourProps:R,theirProps:w,slot:o,attrs:b,slots:u,features:H.RenderStrategy|H.Static,visible:f.value,name:"ListboxOptions"})}}}),Ke=I({name:"ListboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1},id:{type:String,default:()=>`headlessui-listbox.option-${F()}`}},setup(t,{slots:b,attrs:u,expose:L}){let e=j("ListboxOption"),d=D(null);L({el:d,$el:d});let m=O(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t.id:!1),x=O(()=>P(e.mode.value,{[0]:()=>e.compare(T(e.value.value),T(t.value)),[1]:()=>T(e.value.value).some(n=>e.compare(T(n),T(t.value)))})),f=O(()=>P(e.mode.value,{[1]:()=>{var p;let n=T(e.value.value);return((p=e.options.value.find(a=>n.some(l=>e.compare(T(l),T(a.dataRef.value)))))==null?void 0:p.id)===t.id},[0]:()=>x.value})),o=O(()=>({disabled:t.disabled,value:t.value,textValue:"",domRef:d}));A(()=>{var p,a;let n=(a=(p=v(d))==null?void 0:p.textContent)==null?void 0:a.toLowerCase().trim();n!==void 0&&(o.value.textValue=n)}),A(()=>e.registerOption(t.id,o)),_(()=>e.unregisterOption(t.id)),A(()=>{N([e.listboxState,x],()=>{e.listboxState.value===0&&x.value&&P(e.mode.value,{[1]:()=>{f.value&&e.goToOption(g.Specific,t.id)},[0]:()=>{e.goToOption(g.Specific,t.id)}})},{immediate:!0})}),W(()=>{e.listboxState.value===0&&m.value&&e.activationTrigger.value!==0&&C(()=>{var n,p;return(p=(n=v(d))==null?void 0:n.scrollIntoView)==null?void 0:p.call(n,{block:"nearest"})})});function i(n){if(t.disabled)return n.preventDefault();e.select(t.value),e.mode.value===0&&(e.closeListbox(),C(()=>{var p;return(p=v(e.buttonRef))==null?void 0:p.focus({preventScroll:!0})}))}function w(){if(t.disabled)return e.goToOption(g.Nothing);e.goToOption(g.Specific,t.id)}let R=se();function h(n){R.update(n)}function y(n){R.wasMoved(n)&&(t.disabled||m.value||e.goToOption(g.Specific,t.id,0))}function M(n){R.wasMoved(n)&&(t.disabled||m.value&&e.goToOption(g.Nothing))}return()=>{let{disabled:n}=t,p={active:m.value,selected:x.value,disabled:n},{id:a,value:l,disabled:r,...s}=t,S={id:a,ref:d,role:"option",tabIndex:n===!0?void 0:-1,"aria-disabled":n===!0?!0:void 0,"aria-selected":x.value,disabled:void 0,onClick:i,onFocus:w,onPointerenter:h,onMouseenter:h,onPointermove:y,onMousemove:y,onPointerleave:M,onMouseleave:M};return E({ourProps:S,theirProps:s,slot:p,attrs:u,slots:b,name:"ListboxOption"})}}});export{je as Listbox,Fe as ListboxButton,Ae as ListboxLabel,Ke as ListboxOption,Be as ListboxOptions};
